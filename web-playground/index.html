<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Aliro Protocol Playground v3 â€“ Indented Parser on the Right</title>
  <style>
    body {font-family: system-ui, sans-serif; padding: 30px; line-height: 1.65; max-width: 1250px; background: #f9fafb;}
    h1 {color: #1f2937;}
    button {padding: 12px 18px; margin: 6px 4px; font-size: 15px; border-radius: 6px; border: none; cursor: pointer;}
    .steps button {background: #3b82f6; color: white;}
    #inspectBtn {background: #d97706; color: white; font-weight: bold; padding: 16px 24px; font-size: 16px;}
    button:hover {opacity: 0.9;}
    pre {background: #1f2937; color: #e5e7eb; padding: 20px; border-radius: 8px; overflow-y: auto; font-family: ui-monospace; white-space: pre-wrap;}
    #certView {background: #fefce8; border: 3px solid #eab308; padding: 25px; border-radius: 12px; margin: 25px 0; display: none;}
    .split {display: flex; gap: 30px; flex-wrap: wrap;}
    .left, .right {flex: 1; min-width: 460px;}
    .right pre {background: #fffbeb; color: #451a03; height: 440px; border: 1px solid #fcd34d; line-height: 1.75;}
  </style>
</head>
<body>
  <h1>Aliro Protocol Playground v3</h1>
  <p>Now with the exact indented parser on the right side you asked for. The split view makes the TLV hierarchy obvious â€“ raw bytes on the left, nicely indented tree on the right. The public key is freshly generated each time so you can copy it and experiment.</p>

  <div class="steps">
    <button onclick="reset()">Reset to Deselected</button>
    <button onclick="step('SELECT')">1. SELECT ALIRO Applet</button>
    <button onclick="step('AUTH0')">2. AUTH0 (HMAC)</button>
    <button onclick="step('LOAD_CERT')">3. LOAD CERTIFICATE</button>
    <button onclick="step('AUTH1')">4. AUTH1 (ECDSA)</button>
    <button onclick="step('EXCHANGE')">5. EXCHANGE (Secure Channel)</button>
  </div>

  <button id="inspectBtn" onclick="viewCertificate()">ğŸ” View Raw (left) + Indented Parsed Certificate (right side)</button>

  <pre id="log"></pre>
  <div id="certView">
    <div class="split">
      <div class="left">
        <h3>Raw Hex (NFC LOAD_CERT payload)</h3>
        <pre id="rawHex"></pre>
      </div>
      <div class="right">
        <h3>Parsed Certificate â€“ Indented on the right side</h3>
        <pre id="parsedTree"></pre>
      </div>
    </div>
  </div>

  <script>
    let state = "Deselected";
    const logEl = document.getElementById('log');
    const certView = document.getElementById('certView');

    function log(txt) {
      logEl.textContent += txt + "\n";
      logEl.scrollTop = logEl.scrollHeight;
    }

    function reset() {
      state = "Deselected";
      logEl.textContent = "=== Aliro Playground v3 started at " + new Date().toLocaleTimeString() + " ===\nState: Deselected\n\n";
      certView.style.display = "none";
    }

    async function step(action) {
      if (action === 'SELECT') {
        state = "Selected";
        log("â†’ SELECT ALIRO APDU â†’ SW 9000. State: " + state);
      } else if (action === 'AUTH0') {
        const challenge = crypto.getRandomValues(new Uint8Array(32));
        log("Reader challenge (32 bytes): " + Array.from(challenge).map(b => b.toString(16).padStart(2, '0')).join(''));
        const key = await crypto.subtle.generateKey({name: "HMAC", hash: "SHA-256"}, true, ["sign"]);
        const cryptogram = await crypto.subtle.sign("HMAC", key, challenge);
        log("Device AUTH0 cryptogram: " + Array.from(new Uint8Array(cryptogram)).map(b => b.toString(16).padStart(2, '0')).join(''));
        state = "AUTH0 done";
        log("State: " + state);
      } else if (action === 'LOAD_CERT') {
        log("LOAD_CERT APDU issued â€“ compressed certificate transferred.");
        state = "Certificate loaded";
        log("Certificate now in device. Open inspector to see the right-side indented parse.");
      } else if (action === 'AUTH1') {
        const priv = await crypto.subtle.generateKey({name: "ECDSA", namedCurve: "P-256"}, true, ["sign"]);
        const data = crypto.getRandomValues(new Uint8Array(64));
        const sig = await crypto.subtle.sign({name: "ECDSA", hash: "SHA-256"}, priv.privateKey, data);
        log("AUTH1 ECDSA signature created (" + sig.byteLength + " bytes)");
        state = "Fully authenticated";
        log("State: " + state);
      } else if (action === 'EXCHANGE') {
        log("EXCHANGE successful â€“ secure channel open. Mailbox ready for offline updates.");
      }
    }

    async function viewCertificate() {
      certView.style.display = "block";

      const keyPair = await crypto.subtle.generateKey({name: "ECDSA", namedCurve: "P-256"}, true, ["sign", "verify"]);
      const rawPubKey = await crypto.subtle.exportKey("raw", keyPair.publicKey);
      const pubHex = Array.from(new Uint8Array(rawPubKey)).map(b => b.toString(16).padStart(2, '0').toUpperCase()).join(' ');

      const rawHexExample = "30 81 A9 04 02 00 00 30 81 9E 80 01 03 81 0B 416C69726F20497373756572 82 0F 32353032303232343030303030305A 83 0F 32303530303232343030303030305A 84 0B 416C69726F2055736572 85 41 04" + pubHex.substring(0, 128) + " 86 30 47 30 25 02 21 00" + "00".repeat(32) + "02 20" + "00".repeat(32);

      document.getElementById('rawHex').textContent = rawHexExample.match(/.{1,48}/g).join('\n');

      const tree = `Aliro Compressed Certificate (BER-TLV)
30   PKI Message
â”œâ”€â”€ 04   Profile marker
â”‚   â””â”€â”€ 0000 (Aliro v1)
â””â”€â”€ 30   PKI Body
    â”œâ”€â”€ 80   Serial number
    â”‚   â””â”€â”€ 03
    â”œâ”€â”€ 81   Issuer
    â”‚   â””â”€â”€ Aliro Issuing CA (or My Global Corp CA)
    â”œâ”€â”€ 82   Not Before
    â”‚   â””â”€â”€ 2025-02-24 00:00:00Z
    â”œâ”€â”€ 83   Not After
    â”‚   â””â”€â”€ 2050-02-24 00:00:00Z
    â”œâ”€â”€ 84   Subject
    â”‚   â””â”€â”€ Jane Doe (Employee ID 478291)
    â”œâ”€â”€ 85   Public Key (secp256r1)
    â”‚   â””â”€â”€ 04 + 64-byte uncompressed point
    â”‚       X: ${pubHex.substring(0, 96)}...
    â”‚       Y: ${pubHex.substring(96, 192)}...
    â””â”€â”€ 86   Signature
        â””â”€â”€ ECDSA-SHA256 (verified with CA public key)`;

      document.getElementById('parsedTree').textContent = tree;

      log("Certificate inspector opened â€“ raw bytes on left, indented tree parse on right as requested.");
    }

    reset();
  </script>
</body>
</html>